"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _eventsource=_interopRequireDefault(require("eventsource"));Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;class ReconnectingEventSource{constructor(a,b){this._configuration=null==b?null:Object.assign({},b),this._eventSource=null,this._lastEventId=null,this._timer=null,this._listeners={},this.url=a,this.readyState=0,this.max_retry_time=3e3,null!=this._configuration&&(this._configuration.lastEventId&&(this._lastEventId=this._configuration.lastEventId,delete this._configuration.lastEventId),this._configuration.max_retry_time&&(this.max_retry_time=this._configuration.max_retry_time,delete this._configuration.max_retry_time)),this._onevent_wrapped=a=>{this._onevent(a)},this._start()}_start(){var a=this.url;this._lastEventId&&(a+=-1===a.indexOf("?")?"?":"&",a+="lastEventId="+encodeURIComponent(this._lastEventId)),this._eventSource=new _eventsource.default(a,this._configuration),this._eventSource.onopen=a=>{this._onopen(a)},this._eventSource.onerror=a=>{this._onerror(a)},this._eventSource.onmessage=a=>{this.onmessage(a)};for(var b of Object.keys(this._listeners))this._eventSource.addEventListener(b,this._onevent_wrapped)}_onopen(a){0===this.readyState&&(this.readyState=1,this.onopen(a))}_onerror(a){if(1===this.readyState&&(this.readyState=0,this.onerror(a)),this._eventSource&&2===this._eventSource.readyState){this._eventSource.close(),this._eventSource=null;var b=Math.round(this.max_retry_time*Math.random());this._timer=setTimeout(()=>this._start(),b)}}_onevent(a){a.lastEventId&&(this._lastEventId=a.lastEventId);var b=this._listeners[a.type];if(null!=b)for(var c of[...b])c(a);"message"===a.type&&this.onmessage(a)}onopen(){}onerror(){}onmessage(){}close(){this._timer&&(clearTimeout(this._timer),this._timer=null),this._eventSource&&(this._eventSource.close(),this._eventSource=null),this.readyState=2}addEventListener(a,b){var c=a.toString();c in this._listeners||(this._listeners[c]=[],this._eventSource&&this._eventSource.addEventListener(c,this._onevent_wrapped));var d=this._listeners[c];d.includes(b)||(this._listeners[c]=[...d,b])}removeEventListener(a,b){var c=a.toString();if(c in this._listeners){var d=this._listeners[c],e=d.filter(a=>a!==b);0<e.length?this._listeners[c]=e:(delete this._listeners[c],this._eventSource&&this._eventSource.removeEventListener(c,this._onevent_wrapped))}}}exports.default=ReconnectingEventSource;